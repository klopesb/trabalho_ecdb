---
title: "RNA-Seq_analysis_UCEC"
author: "Karolina Barbosa - PG55129"
date: "2025-04-07"
output: html_document
---

# 1ª Parte

A primeira fase do trabalho deve incluir:

-   Explicação dos dados, sua origem e relevância;

-   Tarefas de preparação e de pré-processamento dos dados;

-   Sumarização dos dados (estatística descritiva, exploração com recurso a gráficos;

-   Análise estatística univariada;

-   Análise de expressão diferencial e de enriquecimento.

## Instalação e importação dos packages

Foram instalados os seguintes packages para utilização no trabalho:

```{r}
install.packages(c("data.table", "tidyverse", "Bioconductor", "TCGAbiolinks", "edgeR", "DESeq2"))

library(data.table)
library(tidyverse)
library(TCGAbiolinks)  # For TCGA data
library(SummarizedExperiment)
library(ggplot2)
library(DESeq2)
library(graphics)
library(edgeR)
```

## Introdução

### Explicação dos dados, origem e relevância

## Objetivo

## Extração dos metadados e dos dados transcriptômicos a partir da base de dados

Para facilitar o acesso aos dados de expressão gênica do projeto TCGA-UCEC, relacionado ao câncer de endométrio. Primeiro, o código verifica se já existe um arquivo chamado "rna_data_TCGA_UCEC.rds" salvo localmente. Se esse arquivo estiver disponível, ele simplesmente carrega os dados direto do disco usando a função `readRDS()`. Caso contrário, ele realiza uma consulta ao portal GDC (Genomic Data Commons) com a função `GDCquery()`, especificando que o projeto é o TCGA-UCEC e que os dados de interesse são de expressão gênica processados pelo método "STAR - Counts". Em seguida, os dados são baixados, preparados para análise com `GDCprepare()`, e então salvos no mesmo arquivo .rds para que possam ser reutilizados no futuro.

```{r}
if (file.exists("rna_data_TCGA_UCEC.rds")) {
  rna_data <- readRDS("rna_data_TCGA_UCEC.rds")
} else {
  query <- GDCquery(
    project = "TCGA-UCEC",
    data.category = "Transcriptome Profiling",
    data.type = "Gene Expression Quantification",
    workflow.type = "STAR - Counts"
  )
  
  GDCdownload(query)
  rna_data <- GDCprepare(query)
  saveRDS(rna_data, file = "rna_data_TCGA_UCEC.rds")
}
```

## Preparação e Pré-processamento dos dados

Primeiro, os dados de contagem gênica são extraídos do objeto rna_data com a função `assay()` e convertidos para um data frame, sendo armazenados na variável rna_counts. Da mesma forma, as informações de metadados associadas às amostras são extraídas com `colData()` e armazenadas na variável metadata.

Em seguida, são feitas algumas verificações básicas para garantir a integridade e consistência dos dados. O código examina os nomes das colunas e linhas de ambos os data frames (`rna_counts` e `metadata`) para identificar possíveis problemas, como espaços em branco, caracteres estranhos ou inconsistências. Além disso, a função `dim()` é usada para verificar as dimensões dos dois data frames, garantindo que o número de genes (linhas) e amostras (colunas) esteja de acordo com o esperado.

rna_counts contém 60660 observações de 589 variáveis, e metadata contém 589 observações de 84 variáveis.

Por fim, o código verifica a presença de valores omissos (NA) nos dados utilizando a função `colSums(is.na())`, o que é essencial para assegurar a qualidade dos dados e evitar problemas em análises posteriores. No caso das contagens gênicas (`rna_counts`), não foram encontrados valores omissos, o que indica um bom nível de completude. Já nos metadados (`metadata`), foram identificados alguns valores omissos, o que merece atenção, pois pode impactar certas análises dependendo das variáveis afetadas.

```{r}
rna_counts <- as.data.frame(assay(rna_data))
metadata <- as.data.frame(colData(rna_data)) 


#check black spaces, inconsistencies, odd characters 
colnames(rna_counts) 
rownames(rna_counts)
colnames(metadata)

#check if the number of genes/assays are correct (genes x assays)
dim(rna_counts)

#check if there are essential columns missing on our metadata 
dim(metadata)

#check if there are NA values
colSums(is.na(rna_counts)) 

colSums(is.na(metadata)) 

```

### Metadados

Ao tratar os metadados, foi realizada inicialmente uma verificação da porcentagem de valores omissos (NA) em cada variável, utilizando a função `colSums(is.na())` combinada com o número total de amostras. Essa etapa permitiu identificar quais variáveis apresentavam altos níveis de incompletude. Como critério de filtragem, foram removidas todas as variáveis em que a proporção de valores ausentes ultrapassava 10%. Com isso, das 84 variáveis inicialmente presentes nos metadados, restaram 47 variáveis em `metadata_clean` com dados suficientemente completos para análises subsequentes.

```{r}
#Considering there are NA values in our metadata, we are going to verify it's proportion 
metadata_na_percent <- colSums(is.na(metadata)) / nrow(metadata) * 100
metadata_na_percent
```

```{r}
metadata_clean <- metadata[, colMeans(is.na(metadata)) <= 0.1]
```

### RNA

```{r}
rna_filtered <- rna_counts[apply(rna_counts,1 , sd) > 0, ] #remove lines where expression in is 0


#data standardization - applied z-score to each row(gene)
rna_normalized <- t(scale(t(rna_filtered))) #this way we don't produce NaNs 
colSums(is.na(rna_normalized))

apply(rna_normalized, 1, mean)  # Média de cada gene (deve ser ~0)
apply(rna_normalized, 1, sd)    # Desvio padrão de cada gene (deve ser ~1)

```

## Análise Descritiva e Exploratória

A partir das 47 variáveis restantes nos metadados, foram selecionadas aquelas com maior potencial de relevância para os objetivos do estudo. Para essas variáveis, foram exploradas suas distribuições por meio da função `table()`, o que ajuda a entender como as amostras estão distribuídas entre os diferentes grupos de interesse e a planejar futuras análises comparativas.

```{r}
table(colData(rna_data)$tissue_type)
table(colData(rna_data)$classification_of_tumor)
table(colData(rna_data)$primary_diagnosis)
table(colData(rna_data)$vital_status)
```

As variáveis escolhidas foram:

-   **`tissue_type`**, por permitir a comparação da expressão gênica entre tecidos normais e tumorais;

-   **`classification_of_tumor`**, por possibilitar a análise de diferenças na expressão entre diferentes tipos de tumor;

-   **`vital_status`**, relevante para estudos de sobrevivência, relacionando expressão gênica com o desfecho clínico dos pacientes;

-   **`primary_diagnosis`**, útil para avaliar a expressão gênica em diferentes subtipos de câncer;

-   **`age_at_index`**, que permite investigar possíveis associações entre a idade dos pacientes e os padrões de expressão gênica.

Resumo das variáveis escolhidas:

| Variável                | Tipo       | Descrição         |
|-------------------------|------------|-------------------|
| vital_status            | Categórica | Vivos vs mortos   |
| age_at_index            | Numérica   | Idade do paciente |
| classification_of_tumor | Categórica | Tipo de tumor     |
| tissue_type             | Categórica | Normal vs Tumoral |
| primary_diagnosis       | Categórica | Subtipo de câncer |

Após a seleção das variáveis de interesse, foi criado o objeto `metadata_subset`, mantendo apenas essas variáveis. O objetivo é otimizar o uso de memória, tornar os dados mais organizados e reduzir a chance de erros durante as análises. Para isso, foi utilizada a função `select()` do pacote `dplyr`, selecionando especificamente as colunas `vital_status`, `age_at_index`, `classification_of_tumor`, `tissue_type` e `primary_diagnosis`.

```{r}
metadata_subset <- dplyr::select(
  metadata_clean,
  vital_status,
  age_at_index,
  classification_of_tumor,
  tissue_type,
  primary_diagnosis
)
```

### Análise descritiva das variáveis categóricas

Com o subconjunto de metadados definido, foram realizadas análises exploratórias para melhor compreensão das variáveis selecionadas. Para as variáveis categóricas foram construídas tabelas de frequência, permitindo visualizar a distribuição das amostras entre as diferentes categorias.

#### Vital_Status

A variável `vital_status` representa a condição de sobrevivência dos pacientes com câncer, com as categorias *Alive*, *Dead* e *NA*. Entre as 589 amostras disponíveis, aproximadamente 83% dos pacientes estavam vivos e 17% haviam falecido.

Foi gerada uma tabela de frequência com a proporção percentual de cada categoria. Para complementar, um gráfico de barras foi criado com `ggplot()`, exibindo a distribuição dos estados de vitalidade, excluindo as amostras com valores omissos.

```{r}
table(metadata_subset$vital_status) #Frequência Absoluta

prop.table(table(metadata_subset$vital_status)) * 100 #Frequência Relativa
```

```{r}
ggplot(metadata_subset[!is.na(metadata_subset$vital_status), ], aes(x = vital_status, y = after_stat(prop), group = 1)) +
  geom_bar(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Distribuição: Vital Status", x = "", y = "Proporção") +
  theme(plot.title = element_text(hjust = 0.5))
```

#### Classification of Tumor

A variável `classification_of_tumor` apresenta diferentes classificações tumorais: *primary* (492), *metastasis* (21), *recurrence* (18) e *prior primary* (19).

```{r}
table(colData(rna_data)$classification_of_tumor)
```

Como alguns desses grupos possuem poucas amostras em comparação ao grupo *primary*, optou-se por agrupá-los em uma única categoria. Dessa forma, foi criado um novo objeto `tumor_class` para que as categorias *metastasis*, *recurrence* e *prior primary* fossem unificadas para permitir uma comparação mais robusta com o grupo *primary*.

```{r}
tumor_class <- metadata_subset %>%
  mutate(classification_of_tumor = ifelse(classification_of_tumor == "primary", "primary", "others"))
```

Em seguida, foram geradas tabelas de frequência para visualizar a distribuição da variável `classification_of_tumor`. Para complementar, foi construído um gráfico de barras com `ggplot()`, representando visualmente as classificações tumorais, com exclusão prévia dos casos com valores ausentes. Observa-se que aproximadamente 85% das amostras pertencem à categoria *primary*, enquanto cerca de 15% em *others* estão distribuídas entre as demais classificações (*metastasis*, *recurrence* e *prior primary*).

```{r}
table(tumor_class$classification_of_tumor) #Frequência Absoluta

prop.table(table(tumor_class$classification_of_tumor)) * 100 #Frequência Relativa
```

```{r}
#gráfico de barra 
ggplot(tumor_class[!is.na(tumor_class$classification_of_tumor), ], aes(x = classification_of_tumor)) +
  geom_bar(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Distribuição: Classification of Tumor", x = "", y = "Frequência") +
  theme(plot.title = element_text(hjust = 0.5))
```

#### Tissue_type

A variável `tissue_type` apresenta duas categorias: *normal* e *tumor*. A análise revelou que aproximadamente 94% das amostras correspondem a tecidos tumorais, enquanto cerca de 6% são de tecidos normais. Para representar essa distribuição, foram geradas tabelas de frequência e um gráfico de barras utilizando `ggplot()`, confirmando a predominância de tecidos tumorais no conjunto de dados.

```{r}
table(metadata_subset$tissue_type)
prop.table(table(metadata_subset$tissue_type)) * 100
```

```{r}
ggplot(metadata_subset, aes(x = tissue_type)) +
  geom_bar(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Distribuição: Tissue Type", x = "", y = "Frequência") +
  theme(plot.title = element_text(hjust = 0.5))
```

#### Primary_diagnosis

A variável `primary_diagnosis` apresenta uma ampla diversidade de diagnósticos associados ao câncer endometrial.

```{r}
table(colData(rna_data)$primary_diagnosis)
```

No entanto, duas categorias se destacam: *Endometrioid adenocarcinoma, NOS* com 404 ocorrências e *Serous cystadenocarcinoma, NOS* com 124 ocorrências.

Um novo objeto, `diagnosis_filtered`, foi criado contendo as categorias *Endometrioid adenocarcinoma, NOS* (404) e *Serous cystadenocarcinoma, NOS* (124) explicitamente, enquanto as demais (devido à baixa frequência individual) foram agrupadas sob o rótulo *"Others"*. Essa estratégia teve como objetivo facilitar a análise e garantir maior robustez nas comparações entre os grupos.

```{r}
diagnosis_filtered <- metadata_subset %>%
  mutate(primary_diagnosis = ifelse(
    primary_diagnosis %in% c("Endometrioid adenocarcinoma, NOS", "Serous cystadenocarcinoma, NOS"),
    primary_diagnosis,
    "Others"
  ))
```

Após o agrupamento, foram geradas tabelas de frequência absoluta e relativa para visualizar a distribuição dos diagnósticos. Além disso, foi construído um gráfico de barras com `ggplot()`, que representa visualmente a predominância dos dois principais tipos tumorais, com as demais classificações agrupadas em *"Others"*. Aproximadamente 68% das amostras correspondem a *Endometrioid adenocarcinoma, NOS*, 21% a *Serous cystadenocarcinoma, NOS* e os 10% restantes estão incluídos na categoria *Others*.

```{r}
table(diagnosis_filtered$primary_diagnosis)
prop.table(table(diagnosis_filtered$primary_diagnosis)) * 100
```

```{r}
ggplot(diagnosis_filtered, aes(x = primary_diagnosis, y = after_stat(prop), group = 1)) +
  geom_bar(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Distribuição: Primary Diagnosis", x = "", y = "Frequência") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(plot.title = element_text(hjust = 0.5))

```

### Análise descritiva da variável numérica

Para a variável numérica, foram utilizadas medidas descritivas e gráficos para entender sua distribuição ao longo das amostras.

#### Age_at_Index

A variável `age_at_index` representa a idade dos pacientes. Foi gerado um resumo estatístico com medidas como média, mediana, valores mínimos e máximos, além do desvio padrão (considerando a remoção de valores ausentes). Observa-se que a média de idade dos pacientes é de 64 anos, sendo o paciente mais jovem com 31 anos e o mais velho com 89.

```{r}
summary(metadata_subset$age_at_index)
sd(metadata_subset$age_at_index, na.rm = TRUE)
```

Em seguida, foi criado um gráfico de densidade com `ggplot()` para visualizar a distribuição das idades na amostra. Observa-se uma maior concentração de pacientes entre 50 e 70 anos, refletindo a faixa etária mais prevalente no conjunto de dados.

```{r}
# Histograma de Idade 
ggplot(metadata_subset[!is.na(metadata_subset$age_at_index), ], aes(x = age_at_index)) +
  geom_density(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Densidade da Idade dos Pacientes",
       x = "Idade",
       y = "Densidade")
```

### Comparação entre categorias

#### Idade e status vital

Foi realizada uma comparação entre a idade dos pacientes (`age_at_index`) e o status vital (`vital_status`) com o objetivo de identificar possíveis padrões relacionados à sobrevivência. Para isso, foi gerado um boxplot que evidencia a distribuição das idades em cada categoria (vivo ou falecido).

A análise mostra que pacientes falecidos tendem a apresentar uma média de idade mais avançada, enquanto pacientes vivos apresentam uma média de idade mais jovem. Esse padrão também é reforçado pelas estatísticas descritivas aplicadas a cada grupo, que indicam uma diferença de 5 anos na mediana e na faixa etária média entre os dois estados vitais.

```{r}
#Idade média dos pacientes vivos vs. mortos:
ggplot(metadata_subset[!is.na(metadata_subset$age_at_index), ], aes(x = vital_status, y = age_at_index)) +
  geom_boxplot(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Idade por Status Vital", x = "Status Vital", y = "Idade") +
  theme(plot.title = element_text(hjust = 0.5))

tapply(metadata_subset$age_at_index, metadata_subset$vital_status, summary)

```

#### Idade e tipo de tecido

Foi realizada uma comparação entre a idade (`age_at_index`) dos pacientes e o tipo de tecido (`tissue_type`) para verificar possíveis padrões etários. Para isso, foi gerado um boxplot que exibe a distribuição das idades nos dois grupos de tecido.

A análise mostra que pacientes com tecido tumoral tendem a ser menos jovens em comparação com aqueles com tecido normal. Essa diferença também é observada nas estatísticas descritivas, com a mediana e a média da idade sendo mais altas no grupo de tecido tumoral.

```{r}
# Pacientes com tumor x tecido normal: idade média
ggplot(metadata_subset[!is.na(metadata_subset$age_at_index), ], aes(x = tissue_type, y = age_at_index)) +
  geom_boxplot(fill = "lightcoral") +
  theme_minimal() +
  labs(title = "Idade por Tipo de Tecido", x = "", y = "Idade") +
  theme(plot.title = element_text(hjust = 0.5))

tapply(metadata_subset$age_at_index, metadata_subset$tissue_type, summary)

```

#### Status vital por classificação do tumor

Foi realizada uma análise para investigar a proporção de pacientes vivos e mortos (`vital_status`) em relação à classificação do tumor (`classification_of_tumor`). Para isso, foi gerado um gráfico de barras empilhadas (`geom_bar`) que mostra as proporções de status vital (vivo ou falecido) em cada categoria de classificação do tumor.

A visualização revela que a maioria dos pacientes na classificação *primary* são vivos, enquanto que em *others* há mais mortes do que na classificação *primary*.

```{r}
#Frequência de vivos/mortos por tipo de tumor
ggplot(tumor_class[!is.na(tumor_class$age_at_index), ], aes(x = classification_of_tumor, fill = vital_status)) +
  geom_bar(position = "fill") +  # proporções
  theme_minimal() +
  labs(title = "Proporção de Status Vital por Classificação do Tumor",
       x = "Classificação do Tumor", y = "Proporção") +
  scale_y_continuous(labels = scales::percent)

tapply(tumor_class$age_at_index, tumor_class$vital_status, summary)

```

### Testes de Hipótese

Para todos os testes de hipótese, foi considerado um valor de p \< 0.05 como indicativo de significância estatística.

Inicialmente, foi testado se a variável numérica `age_at_index` segue uma distribuição normal. Para isso, foi realizada a aplicação do teste de normalidade de Shapiro-Wilk, onde:

-   H0 (Hipótese nula): Os dados seguem uma distribuição normal.

-   H1 (Hipótese alternativa): Os dados não seguem uma distribuição normal.

```{r}
shapiro.test(metadata_subset$age_at_index)
```

Com um valor de p inferior a 0.05, rejeitamos a hipótese nula, indicando que **os dados não seguem uma distribuição normal.**

#### Vital Status vs. Age at Index

Para analisar se a idade média dos pacientes difere entre os grupos "vivos" e "mortos", foi aplicado o teste de Mann-Whitney (Wilcoxon rank sum test), devido à natureza não paramétrica dos dados.

As hipóteses formuladas foram:

-   H0 (Hipótese nula): A média da idade dos pacientes vivos é igual à média dos pacientes mortos.

-   H1 (Hipótese alternativa): A média da idade dos pacientes vivos é diferente da média dos pacientes mortos.

```{r}
wilcox.test(age_at_index ~ vital_status, data = metadata_subset)
```

Com um valor de p \< 0.05, rejeitamos a hipótese nula, indicando que **a média de idade dos pacientes vivos é significativamente diferente da média de idade dos pacientes mortos**.

#### Age at Index vs. Tissue Type

Para verificar se a idade média dos pacientes difere entre os grupos de tecido normal e tecido tumoral, foi aplicado o teste de Mann-Whitney (Wilcoxon rank sum test), considerando a natureza não paramétrica dos dados.

As hipóteses formuladas foram:

-   H0 (Hipótese nula): A média da idade dos pacientes é igual entre os tecidos normais e tumorais.

-   H1 (Hipótese alternativa): A média da idade dos pacientes difere entre os tecidos normais e tumorais.

```{r}
wilcox.test(age_at_index ~ tissue_type, data = metadata_subset)
```

Com um valor de p \< 0.05, rejeitamos a hipótese nula, indicando que **a média de idade dos pacientes com tecido tumoral é significativamente diferente da média de idade dos pacientes com tecido normal.**

#### Age at Index vs. Primary Diagnosis

Para verificar se a idade média dos pacientes difere entre os diferentes diagnósticos primários, foi aplicado o teste de Kruskal-Wallis, dado que a variável de diagnóstico é categórica e a distribuição de idades é não paramétrica.

As hipóteses formuladas foram:

-   H0 (Hipótese nula): A média da idade dos pacientes é igual entre todos os diagnósticos primários.

-   H1 (Hipótese alternativa): A média da idade dos pacientes difere entre pelo menos dois diagnósticos primários.

```{r}
kruskal.test(age_at_index ~ primary_diagnosis, data = diagnosis_filtered)
```

Como o valor de p \< 0.05, rejeitamos a hipótese nula, indicando que **há uma diferença significativa na idade média entre os pacientes com diferentes diagnósticos primários.**

#### Age at Index vs. Classification of Tumor

Para verificar se a idade média dos pacientes difere entre os diferentes tipos de tumor, foi aplicado o teste de Kruskal-Wallis, dado que a variável de classificação do tumor é categórica e a distribuição de idades é não paramétrica.

As hipóteses formuladas foram:

-   H0 (Hipótese nula): Não há diferença significativa entre as idades e os diferentes tipos de tumor.

-   H1 (Hipótese alternativa): Pelo menos um tipo de tumor tem uma idade média diferente.

```{r}
kruskal.test(age_at_index ~ classification_of_tumor, data = tumor_class)
```

Como o valor de p \> 0.05, não rejeitamos a hipótese nula, indicando que não há diferença significativa na idade média entre os diferentes tipos de tumor.

#### Vital Status vs. Classification of Tumor

Para investigar a associação entre vital_status (status vital) e classification_of_tumor (classificação do tumor), foi utilizado o teste de qui-quadrado de Pearson, com a correção de continuidade de Yates, para avaliar se as duas variáveis são independentes ou se existe uma associação significativa entre elas.

As hipóteses formuladas foram:

-   H0 (Hipótese nula): Não há associação entre vital_status e classification_of_tumor (as duas variáveis são independentes).

-   H1 (Hipótese alternativa): Existe uma associação significativa entre vital_status e classification_of_tumor.

```{r}
contingency_table <- table(tumor_class$vital_status, tumor_class$classification_of_tumor)
chisq.test(contingency_table)
```

Como o valor de p \< 0.05, rejeitamos a hipótese nula, **indicando que existe uma associação significativa entre o status vital e a classificação do tumor.**

## Análise de expressão diferencial e de enriquecimento

### Análise de expressão diferencial
